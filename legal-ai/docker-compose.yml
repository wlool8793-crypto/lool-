version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════════
# LEGAL AI SYSTEM - Production Grade Infrastructure
# ═══════════════════════════════════════════════════════════════════════════════
# Services:
#   - Qdrant: Vector database (3 collections for hierarchical search)
#   - Neo4j: Knowledge graph (citation network, legal concepts)
#   - Elasticsearch: BM25 full-text search
#   - Redis: Caching and rate limiting
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════
  # QDRANT - Vector Database (3 collections)
  # Collections: case_abstracts, legal_chunks, hyde_questions
  # ═══════════════════════════════════════════════════════════════
  qdrant:
    image: qdrant/qdrant:v1.7.0
    container_name: legal-ai-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC API (faster operations)
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  # ═══════════════════════════════════════════════════════════════
  # NEO4J - Knowledge Graph Database
  # Nodes: Case, Statute, LegalConcept, Judge
  # Relationships: CITES, AFFIRMS, REVERSES, OVERRULES, INTERPRETS
  # ═══════════════════════════════════════════════════════════════
  neo4j:
    image: neo4j:5.15.0
    container_name: legal-ai-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"   # HTTP Browser
      - "7687:7687"   # Bolt Protocol
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-legal_ai_2024}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=1G
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # ═══════════════════════════════════════════════════════════════
  # ELASTICSEARCH - BM25 Full-Text Search
  # Index: legal_documents with legal_analyzer
  # ═══════════════════════════════════════════════════════════════
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: legal-ai-elasticsearch
    restart: unless-stopped
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - cluster.name=legal-ai-cluster
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # ═══════════════════════════════════════════════════════════════
  # REDIS - Caching & Rate Limiting
  # Used for: Query cache, embedding cache, rate limits
  # ═══════════════════════════════════════════════════════════════
  redis:
    image: redis:7.2-alpine
    container_name: legal-ai-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --save 300 10
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

volumes:
  qdrant_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  elasticsearch_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: legal-ai-network
    driver: bridge
